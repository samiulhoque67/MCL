@{
    Layout = "~/Views/Shared/_AdminLteLayout.cshtml";
}

<style>
    .link_total_bm {
        color: black;
        font-weight: bold;
    }

        .link_total_bm :hover {
            color: #0091EA !important;
            font-weight: bold;
        }

    .link_within_bm {
        color: green;
        font-weight: bold;
    }

        .link_within_bm :hover {
            color: #0091EA;
            font-weight: bold;
        }

    .link_out_bm {
        color: firebrick;
        font-weight: bold;
    }

        .link_out_bm :hover {
            color: #0091EA;
            font-weight: bold;
        }

    .global-search {
        height: 34px;
    }

    .btn-round {
        border-radius: 17px;
    }

    .box.box-solid.box-primary > .box-header {
        text-align: center;
    }
</style>

<div class="box box-primary box-body" ng-controller="VendorCSAprvCtrl">
    <div class="box-header with-border" style="font-family: Verdana; background: #E4E9E3; color: black; ">
        <i class="fa fa-user"></i>
        <h3 style="font-family: Verdana" class="box-title">Vendor CS Approval</h3>

        <div class="box-tools pull-right">
            <div class="col-lg-12 pull-right">
                <div class="btn-group pull-right" style="margin-left: 4px; margin-right: 4px;">
                    <button type="button" data-ng-click="toggleRefreshTable()" class="btn btn-warning btn-flat pull-right" ng-disabled="btnRefresh"><i class="fa fa-refresh" style="padding-right: 5px"></i>Refresh</button>
                </div>
                <div class="btn-group pull-right" style="margin: 3px">
                    @using (Html.BeginForm("VendorCSApprevedReport", "../Reports", FormMethod.Post, new { target = "_blank", name = "H1Form", id = "H1Form" }))
                    {
                        <button ng-disabled="showPrint" type="submit" id="btnSubmit" name="ReportType" class="btn btn-sm btn-flat btn-success pull-right">
                            <i class="fa fa-print"></i> CS Print
                        </button>
                    }


                </div>
                <div class="btn-group pull-right" style="margin-left: 4px; margin-right: 4px;">
                    <button type="button" data-ng-click="SearchVendorReqModal()" class="btn btn-flat btn-primary pull-right " ng-disabled="btnSearch"><i class="fa fa-search" style="padding-right: 5px"></i>Search</button>
                </div>
                <div class="btn-group pull-right" style="margin-left: 4px; margin-right: 4px;">
                    <button type="button" data-ng-click="Post()" class="btn btn-flat btn-primary pull-right " ng-disabled="btnSave"><i class="fa fa-save" style="padding-right: 5px"></i>   {{ VendorReq.VendorReqID ? 'Update' : 'Save' }}</button>
                </div>
                <div class="btn-group pull-right" style="margin-left: 4px; margin-right: 4px;">
                    <button type="button" data-ng-click="Cancel()" class="btn btn-flat btn-primary pull-right " ng-disabled="btnSave"><i class="fa fa-save" style="padding-right: 5px"></i>Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-2">
            <div class="box box-primary box-solid">
                <div class="box-header with-border" style="padding-top:5px;padding-bottom:5px">
                    <h3 class="box-title text-center">{{dashBoardResult[0].ServiceCategoryName}}</h3>
                </div>

                <div style="padding-top:5px;padding-bottom:5px">
                    <button id="dashBoardResult[0].ServiceCategoryID" ng-click="VendorSelect(dashBoardResult[0].ServiceCategoryID)">
                        <div class="col-sm-2 border-right" style="padding-left:5px;">
                            <h5 class="description-header">{{dashBoardResult[0].ServicesCategoryCount}}</h5>
                        </div>
                    </button>
                </div>

            </div>
        </div>
        <div class="col-md-2">
            <div class="box box-primary box-solid">
                <div class="box-header with-border" style="padding-top:5px;padding-bottom:5px">
                    <h3 class="box-title text-center">{{dashBoardResult[1].ServiceCategoryName}}</h3>
                </div>

                <div class="box-body">
                    <div class="row">
                        <button id="dashBoardResult[1].ServiceCategoryID" ng-click="VendorSelect(dashBoardResult[1].ServiceCategoryID)">
                            <div class="col-sm-2 border-right">
                                <h5 class="description-header">{{dashBoardResult[1].ServicesCategoryCount}}</h5>
                            </div>
                        </button>
                    </div>
                </div>

            </div>
        </div>
        <div class="col-md-2">
            <div class="box box-primary box-solid">
                <div class="box-header with-border" style="padding-top:5px;padding-bottom:5px">
                    <h3 class="box-title text-center">{{dashBoardResult[2].ServiceCategoryName}}</h3>
                </div>

                <div class="box-body">
                    <div class="row">
                        <button id="dashBoardResult[2].ServiceCategoryID" ng-click="VendorSelect(dashBoardResult[2].ServiceCategoryID)">
                            <div class="col-sm-2 border-right">
                                <h5 class="description-header">{{dashBoardResult[2].ServicesCategoryCount}}</h5>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="box box-primary box-solid">
                <div class="box-header with-border" style="padding-top:5px;padding-bottom:5px">
                    <h3 class="box-title text-center">{{dashBoardResult[3].ServiceCategoryName}}</h3>
                </div>

                <div class="box-body">
                    <div class="row">
                        <button id="dashBoardResult[3].ServiceCategoryID" ng-click="VendorSelect(dashBoardResult[3].ServiceCategoryID)">
                            <div class="col-sm-2 border-right">
                                <h5 class="description-header">{{dashBoardResult[3].ServicesCategoryCount}}</h5>
                            </div>
                        </button>
                    </div>
                </div>

            </div>
        </div>
        <div class="col-md-2">
            <div class="box box-primary box-solid">
                <div class="box-header with-border" style="padding-top:5px;padding-bottom:5px">
                    <h3 class="box-title text-center">{{dashBoardResult[4].ServiceCategoryName}}</h3>
                </div>

                <div class="box-body">
                    <div class="row">
                        <button id="dashBoardResult[4].ServiceCategoryID" ng-click="VendorSelect(dashBoardResult[4].ServiceCategoryID)">
                            <div class="col-sm-2 border-right">
                                <h5 class="description-header">{{dashBoardResult[4].ServicesCategoryCount}}</h5>
                            </div>
                        </button>
                    </div>
                </div>

            </div>
        </div>
        <div class="col-md-2">
            <div class="box box-primary box-solid">
                <div class="box-header with-border" style="padding-top:5px;padding-bottom:5px">
                    <h3 class="box-title text-center">{{dashBoardResult[5].ServiceCategoryName}}</h3>
                </div>

                <div class="box-body">
                    <div class="row">
                        <button id="dashBoardResult[5].ServiceCategoryID" ng-click="VendorSelect(dashBoardResult[5].ServiceCategoryID)">
                            <div class="col-sm-2 border-right">
                                <h5 class="description-header">{{dashBoardResult[5].ServicesCategoryCount}}</h5>
                            </div>
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="row" style="margin: 1%; background-color: #f0f0f0; box-shadow: 2px 2px 5px #888888; padding: 5px 10px 5px 10px;">
        <div class="row">
            <div class="row" style="padding: 11px; margin-right: 15px; margin-left: 15px;">
                <table st-table="CSClientDisplayedCollection" st-safe-src="CSClientList" class="table table-condensed table-bordered table-striped table-hover pnlView">
                    <thead>
                        <tr>
                            <th class="col-lg-3 col-md-3 col-sm-3" data-ng-click="sort('ClientName')">Client Name</th>
                            <th class="col-lg-2 col-md-2 col-sm-2" data-ng-click="sort('ClientReqNo')">Requisition No</th>
                            <th class="col-lg-2 col-md-2 col-sm-2" data-ng-click="sort('RequisitionDate')">Requisition Date</th>
                            <th class="col-lg-2 col-md-2 col-sm-2" data-ng-click="sort('NoOfVendor')">NoOfVendor</th>
                            <th class="col-lg-1 col-md-1 col-sm-1">Action</th>
                        </tr>
                        @*<tr>
                                <th><input st-search="ClientName" placeholder="Client Name" class="input-sm form-control" type="search" /></th>
                                <th><input st-search="ClientReqNo" placeholder="Client Req.No" class="input-sm form-control" type="search" /></th>
                            </tr>*@
                    </thead>
                    <tbody>
                        <tr ng-repeat="row in CSClientDisplayedCollection">
                            <td class="hidden">{{row.ClientReqID}}</td>
                            <td class="hidden">{{row.ClientID}}</td>
                            <td class="col-lg-3 col-md-3 col-sm-3 text-left">{{row.ClientName}}</td>
                            <td class="col-lg-2 col-md-2 col-sm-2 text-left">{{row.ClientReqNo}}</td>
                            <td class="col-lg-2 col-md-2 col-sm-2 text-center">{{row.RequisitionDate}}</td>
                            <td class="col-lg-2 col-md-2 col-sm-2 text-center">{{row.NoOfVendor}}</td>
                            <td>
                                <a class="btn col-center btn-sm btn-flat btn-success" data-ng-click="ClientSelect(row)">Details</a>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        @*<tr>
                                <td colspan="11" class="text-center"><div st-pagination="" st-items-by-page="itemsByPage" st-displayed-pages="10"></div></td>
                            </tr>*@
                    </tfoot>
                </table>
            </div>
        </div>
    </div>


    <div class="row" style="margin: 1%; background-color: #f0f0f0; box-shadow: 2px 2px 5px #888888; padding: 5px 10px 5px 10px;">
        <div class="row">
            <div class="row" style="padding: 11px; margin-right: 15px; margin-left: 15px;">
                <table st-table="CSVendorDisplayedCollection" st-safe-src="CSVendorList" class="table table-condensed table-bordered table-striped table-hover pnlView">
                    <thead>
                        <tr>
                            <th class="col-lg-1 col-md-1 col-sm-1" data-ng-click="sort('VendorName')">Vendor Name</th>
                            <th class="col-lg-1 col-md-1 col-sm-1" data-ng-click="sort('ContactPerson')">Contact Person</th>
                            <th class="col-lg-1 col-md-1 col-sm-1" data-ng-click="sort('ContactNumber')">Contact Number</th>
                            <th class="col-lg-1 col-md-1 col-sm-1" data-ng-click="sort('VendorQutnNo')">VendorQutnNo</th>
                            <th class="col-lg-1 col-md-1 col-sm-1" data-ng-click="sort('QuotationDate')">QuotationDate</th>
                            <th class="col-lg-1 col-md-1 col-sm-1" data-ng-click="sort('TolQnty')">TolQnty</th>
                            <th class="col-lg-1 col-md-1 col-sm-1">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="row in CSVendorDisplayedCollection" ng-cloak style="font-size:12px;">
                            <td class="hidden">{{row.index+1}}</td>
                            <td class="hidden">{{row.VendorCSRecmID}}</td>
                            <td class="hidden">{{row.VendorID}}</td>
                            <td class="col-lg-3 col-md-3 col-sm-3 text-center">{{row.VendorName}}</td>
                            <td class="col-lg-1 col-md-1 col-sm-1 text-center">{{row.ContactPerson}}</td>
                            <td class="col-lg-1 col-md-1 col-sm-1 text-center">{{row.ContactNumber}}</td>
                            <td class="col-lg-3 col-md-3 col-sm-3 text-center">{{row.VendorQutnNo}}</td>
                            <td class="col-lg-3 col-md-3 col-sm-3 text-center">{{row.QuotationDate}}</td>
                            <td class="col-lg-3 col-md-3 col-sm-3 text-center">{{row.TolQnty}}</td>
                            <td class="col-lg-1" style="width:5%;">
                                <button type="button" class="ChildButtons" ng-click="selectEntity(row)" data-dismiss="modal" title="Select">
                                    <i ng-show="!row.buttonCheckedforVendor" class="fa fa-square-o"></i>
                                    <i ng-show="row.buttonCheckedforVendor" class="fa fa-check-square-o"></i>
                                </button>
                            </td>
                            <td>
                                <button type="button" class="btn col-center btn-sm btn-flat btn-success" data-ng-click="ItemSelect(row)">Details</button>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        @*<tr>
                                <td colspan="11" class="text-center"><div st-pagination="" st-items-by-page="itemsByPage" st-displayed-pages="10"></div></td>
                            </tr>*@
                    </tfoot>
                </table>
            </div>
        </div>
    </div>


    <div class="row" style="margin: 1%; background-color: #f0f0f0; box-shadow: 2px 2px 5px #888888; padding: 5px 10px 5px 10px;">
        <div class="row">
            <div class="row" style="padding: 11px; margin-right: 15px; margin-left: 15px;">
                <table st-table="VenCSItemGridDisplayCollection" st-safe-src="VenCSItemList" class="table table-condensed table-bordered table-striped table-hover pnlView">
                    <thead>
                        <tr>
                            <th style="text-align: left;" st-sort="">Item Code</th>
                            <th style="text-align: left;" st-sort="">Item Name</th>
                            <th style="text-align: left;" st-sort="">ReqQnty</th>
                            <th style="text-align: left;" st-sort="">ReqUnit</th>
                            <th style="text-align: left;" st-sort="">QutnQnty</th>
                            <th style="text-align: left;" st-sort="">QutnPrice</th>
                            <th style="text-align: left;" st-sort="">QutnAmt</th>
                            <th style="text-align: left;" st-sort="">VatPerc</th>
                            <th style="text-align: left;" st-sort="">VatAmt</th>
                            <th style="text-align: left;" st-sort="">TolAmt</th>

                            @*<th style="text-align: left;">Action</th>*@
                        </tr>
                        @*<tr>
                                <th colspan="5"><input st-search="" placeholder="Search" class="input-sm form-control" type="search" /></th>
                            </tr>*@
                    </thead>
                    <tbody>
                        <tr ng-repeat="row in VenCSItemGridDisplayCollection" ng-cloak style="font-size:12px;">
                            <td class="hidden">{{row.index+1}}</td>
                            <td class="hidden">{{row.VendorCSAprvItemID}}</td>
                            <td class="hidden">{{row.VendorCSAprvID}}</td>
                            <td class="col-lg-1" style="width:5%;">{{ row.ServiceItemID }} </td>
                            <td class="col-lg-1" style="width:5%;">{{row.ServiceItemName}}</td>
                            <td class="col-lg-1" style="width:6%;">{{row.ReqQnty | number:2}}</td>
                            <td class="col-lg-1" style="width:5%;">{{row.ReqUnit}}</td>
                            <td class="col-lg-1" style="width:6%;">{{row.QutnQnty}}</td>
                            <td class="col-lg-1" style="width:6%;">{{row.QutnPrice}}</td>
                            <td class="col-lg-1" style="width:6%;">{{row.QutnAmt}}</td>
                            <td class="col-lg-1" style="width:6%;">{{row.VatPerc}}</td>
                            <td class="col-lg-1" style="width:6%;">{{row.VatAmt}}</td>
                            <td class="col-lg-1" style="width:6%;">{{row.TolAmt}}</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        @*<tr>
                                <td colspan="11" class="text-center"><div st-pagination="" st-items-by-page="itemsByPage" st-displayed-pages="10"></div></td>
                            </tr>*@
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="row">
            <div class="col-sm-1 col-md-1 col-lg-1">
            </div>
            <div class="col-lg-2">
                <div class="form-group">
                    <label>CS Date</label>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="form-group">
                    <input id="CSRecDate" name="CSRecDate" type="text" class="DatePicker form-control" placeholder="DD/MM/YYYY" ng-model="VendorCSAprv.CSRecDate" />
                </div>
            </div>

            <div class="col-lg-2">
                <div class="form-group">
                    <label>CS No:</label>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="form-group">
                    <input id="AutoCSNo" name="AutoCSNo" type="text" class="form-control" placeholder="Auto CS No" ng-model="VendorCSAprv.AutoCSNo" ng-readonly="true" />
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-1 col-md-1 col-lg-1">
            </div>
            <div class="col-lg-2">
                <div class="form-group">
                    <label>Operation:</label>
                </div>
            </div>
            <div class="col-lg-3">
                <select data-ng-model="VendorCSAprv.Operation" class="form-control">
                    <option value="">-- None --</option>
                    <option value="Aprv">Approved</option>
                    <option value="Rec">Recommended</option>
                    <option value="Bck">Back</option>
                    <option value="Pst">Postponed</option>
                    <option value="Can">Cancel</option>
                </select>
            </div>

            <div class="col-lg-2">
                <div class="form-group">
                    <label for="Note">Note:</label>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="form-group">
                    <input id="Remarks" name="Remarks" type="text" data-ng-model="VendorCSAprv.Remarks" class="form-control" placeholder="Note for CS" />
                </div>
            </div>

        </div>

    </div>

    <div class="row" style="margin: 1%; background-color: #f0f0f0; box-shadow: 2px 2px 5px #888888; padding: 5px 10px 5px 10px;">
        <div class="row">
            <div class="row" style="padding: 11px; margin-right: 15px; margin-left: 15px;">
                <table st-table="ReqTermGridDisplayCollection" st-safe-src="ReqTermDataSetupGridData" class="table table-condensed table-bordered table-striped table-hover pnlView">
                    <thead>
                        <tr>
                            <th style="text-align: left;" st-sort="">Terms Code</th>
                            <th style="text-align: left;" st-sort="">Terms & Conditions</th>
                            <th style="text-align: left;">Action</th>
                        </tr>
                        @*<tr>
                                <th colspan="5"><input st-search="" placeholder="Search" class="input-sm form-control" type="search" /></th>
                            </tr>*@
                    </thead>
                    <tbody>
                        <tr ng-repeat="row in ReqTermGridDisplayCollection" ng-cloak style="font-size:12px;">
                            <td class="hidden">{{row.VendorCSAprvTermsID}}</td>
                            <td class="hidden">{{row.VendorCSAprvID}}</td>
                            <td class="hidden">{{row.TermsID}}</td>
                            <td class="col-lg-1" style="width:5%;">{{row.TermsCode}}</td>
                            <td class="col-lg-1" style="width:6%;">{{row.TermsName}}</td>

                            <td class="col-lg-1" style="width:5%;">
                                <button type="button" ng-if="row.VendorCSAprvTermsID" class="btn btn-xs btn-primary btn-flat btnEdit" data-ng-click="toggleReqTermEdit(row,$index)"><i class="fa fa-edit"></i> </button>
                                <button type="button" ng-if="!row.VendorCSAprvTermsID" class="btn btn-xs btn-primary btn-flat btnEdit" data-ng-click="toggleReqTermEdit(row,$index)"><i class="fa fa-edit"></i> </button>
                                <button type="button" class="btn btn-xs btn-primary btn-flat btnDelete" data-ng-click="toggleReqTermDelete(row,$index)"><i class="fa fa-remove"></i> </button>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        @*<tr>
                                <td colspan="11" class="text-center"><div st-pagination="" st-items-by-page="itemsByPage" st-displayed-pages="10"></div></td>
                            </tr>*@
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">

    app.controller('VendorCSAprvCtrl', ['$scope', '$http', function ($scope, $http) {

        $scope.vendorCSItemArray = [];
        $scope.vendorCSTermArray = [];
        $scope.itemsByPage = 10;

        $scope.dashBoardResult = {};

        $http.get('/VendorCSAprv/GetVendorCSAprvDashBordData')
            .success(function (response) {
                $scope.loading = false;
                $scope.dashBoardResult = response.result;
            }).error(function () { });

        $scope.VendorSelect = function (ServiceCategoryID) {
            $scope.VendorCSAprv.ServiceCategoryID = ServiceCategoryID;
            $http.post("/VendorCSAprv/GetVendorCSClientInfo?ServiceCategoryID=" + ServiceCategoryID)
                .success(function (response) {
                    $scope.CSClientList = response.CSClientList;
                    $scope.CSClientDisplayedCollection = [].concat($scope.CSClientList);
                })
                .error(function () { });
        };

        $scope.ClientSelect = function (row) {
            $scope.VendorCSAprv.ClientID = row.ClientID;
            $scope.VendorCSAprv.ClientName = row.ClientName;
            $scope.ReportModel.ClientName = row.ClientName;
            $scope.VendorCSAprv.ClientReqID = row.ClientReqID;
            $http.post("/VendorCSAprv/GetVendorCSVendorsUsingClient?ClientID=" + row.ClientID)
                .success(function (response) {
                    $scope.CSVendorList = response.CSVendorList;
                    $scope.CSVendorDisplayedCollection = [].concat($scope.CSVendorList);
                    $scope.CSVendorDisplayedCollection.forEach(function (item, index) {
                        // Add an index field to each object
                        item.index = index; // Adding 1 to start index from 1
                    });
                })
                .error(function () { });
        };

        $scope.ItemSelect = function (row) {
            $scope.VendorCSAprv.ClientName = row.ClientName;
            //$http.post("/VendorCSAprv/GetVendorCSQuotationItem?VendorID=" + row.VendorID)
            $http.post('/VendorCSAprv/GetVendorCSQuotationItem', { VendorID: row.VendorID, ClientID: $scope.VendorCSAprv.ClientID })
                .success(function (response) {
                    $scope.VenCSItemList = response.VenCSItemList;
                    $scope.VenCSItemGridDisplayCollection = [].concat($scope.VenCSItemList);
                })
                .error(function () { });

            $http.post('/VendorCSAprv/GetVendorCSAprvTermList', { VendorCSRecmID: row.VendorCSRecmID })
                .success(function (response) {
                    $scope.ReqTermDataSetupGridData = response.VendorCSAprvTermList;
                    $scope.ReqTermGridDisplayCollection = [].concat($scope.ReqTermDataSetupGridData);
                    $scope.loading = false;
                }).error(function () {
                    $scope.loading = false;
                });
        };

        $scope.ReportModel = {
            ClientName: "",
            Remarks: ""
            //,
            //VendorID: "",
            //ClientReqID: "",
            //ClientID: "",
            //AutoCSNo: "",
            //CSRecDate: "",
            //Operation: "",
            //RecommendedBy: "",
            //Remarks: "",
            //Status: ""
        }

        $scope.VendorCSAprv = {
            VendorCSRecmID: "",
            ServiceCategoryID: "",
            VendorID: "",
            ClientReqID: "",
            ClientID: "",
            AutoCSNo: "",
            CSRecDate: "",
            Operation: "",
            RecommendedBy: "",
            Remarks: "",
            Status: ""
        }

        $scope.VendorCSAprvItem = {
            VendorCSRecmItemID: "",
            VendorCSRecmID: "",
            ServiceCategory: { ServiceCategoryID: "", ServiceCategoryName: "" },
            ServiceItem: { ServiceItemID: "", ServiceItemName: "" },
            ReqQnty: "",
            ReqUnit: "",
            QutnQnty: "",
            QutnPrice: "",
            QutnUnit: "",
            QutnAmt: "",
            VatPerc: "",
            VatAmt: "",
            TolAmt: ""
        }

        $scope.VendorCSVendorsItemWise = {
            VendorCSVendorsItemWiseID: "",
            VendorCSAprvID: "",
            VendorCSAprvItemID: "",
            VendorID: "",
            VendorName: "",
            TolQnty: "",
            VendorCSRecmID: "",
            //ContactPerson: "",
            //ContactNumber: "",
            //VendorTINNo: "",
            //VendorBINNo: "",
            //VendorEmail: "",
            //VendorAddress: "",
            //VenReqQnty: "",
            //VenReqUnit: "",
            Status: ""
        }

        $('.DatePicker').datepicker({
            format: "dd/mm/yyyy",
            autoclose: true
            // Set minDate to 0 to disable selecting previous dates
        });

        $('.DatePicker')
            .on('changeDate', function (ev) {
                $('.datepicker').hide();
            });

        // ################# Detail Add Modal ####################
        $scope.AddReqItemModal = function () {

            if ($('#RequisitionNo').val() == "") {
                toastr.error("Vendor ReqNo.  Required");
                return;
            }

            if ($('#SubmissionDate').val() == "") {
                toastr.error("Submission Date Required.");
                return;
            }

            if ($('#RequisitionDate').val() == "") {
                toastr.error("Requisition Date Date Required");
                return;
            }
            $('#RequisitionItemModal').modal('show');
        };

        $scope.VenCSItemList = [];  // base collection
        $scope.VenCSItemGridDisplayCollection = [].concat($scope.VenCSItemList);

        $scope.AddReqItem = function () {

            if ($scope.VendorCSAprvItem.ServiceCategory.ServiceCategoryID == "") {
                toastr.error("Service Category Required");
                return;
            }

            if ($scope.VendorCSAprvItem.ServiceItem.ServiceItemID == "") {
                toastr.error("Service Item  Required");
                return;
            }

            if ($scope.VendorCSAprvItem.DeliveryMode == "") {
                toastr.error("Submission Date Required.");
                return;
            }

            if ($scope.VendorCSAprvItem.ReqUnit == "") {
                toastr.error("Requisition Date Date Required");
                return;
            }

            if ($('#DeliveryLocation').val() == "") {
                toastr.error("Service Category Required");
                return;
            }

            if ($('#DeliveryDate').val() == "") {
                toastr.error("Service Item  Required");
                return;
            }

            if ($('#Description').val() == "") {
                toastr.error("Submission Date Required.");
                return;
            }

            if ($('#ReqQnty').val() == "") {
                toastr.error("Requisition Date Date Required");
                return;
            }

            $scope.VendorCSAprvItem.ServiceCategoryID = $scope.VendorCSAprvItem.ServiceCategory.ServiceCategoryID;
            $scope.VendorCSAprvItem.ServiceCategoryName = $scope.VendorCSAprvItem.ServiceCategory.ServiceCategoryName;
            $scope.VendorCSAprvItem.ServiceItemID = $scope.VendorCSAprvItem.ServiceItem.ServiceItemID;
            $scope.VendorCSAprvItem.ServiceItemName = $scope.VendorCSAprvItem.ServiceItem.ServiceItemName;

            $scope.VendorCSAprvItem.DeliveryMode = $scope.VendorCSAprvItem.DeliveryMode;
            $scope.VendorCSAprvItem.ReqUnit = $scope.VendorCSAprvItem.ReqUnit;

            $scope.VendorCSAprvItem.DeliveryLocation = $('#DeliveryLocation').val();
            $scope.VendorCSAprvItem.DeliveryDate = $('#DeliveryDate').val();
            $scope.VendorCSAprvItem.Description = $('#Description').val();
            $scope.VendorCSAprvItem.ReqQnty = $('#ReqQnty').val();

            $scope.vendorCSItemArray.push($scope.VendorCSAprvItem);

            $scope.VenCSItemGridDisplayCollection = $scope.VenCSItemGridDisplayCollection.concat($scope.VendorCSAprvItem);

            $scope.resetVendorCSAprvItem();
            $("#btnAddReqItem").html('Add');
            $('#RequisitionItemModal').modal('hide');
        }

        $scope.resetVendorCSAprvItem = function () {
            $('#DeliveryDate').val('');
            $scope.VendorCSAprvItem = {
                VendorCSAprvItemID: "",
                VendorCSAprvID: "",
                ServiceCategory: { ServiceCategoryID: "", ServiceCategoryName: "" },
                ServiceItem: { ServiceItemID: "", ServiceItemName: "" },
                Description: "",
                DeliveryLocation: "",
                DeliveryDate: "",
                DeliveryMode: "",
                ReqQnty: "",
                ReqUnit: ""
            }
        }

        $scope.toggleClientReqSelect = function (tableRow) {
            $scope.VendorCSAprv.ClientReqID = tableRow.ClientReqID;
            $scope.VendorCSAprv.ClientID = tableRow.ClientID;
            $scope.VendorCSAprv.ClientName = tableRow.ClientName;
            $http.post('/ClientRequisition/GetClientReqItemList', { ClientReqID: tableRow.ClientReqID })
                .success(function (response) {
                    $scope.VenCSItemList = response.ClientReqItemList;
                    $scope.VenCSItemGridDisplayCollection = [].concat($scope.VenCSItemList);
                    $scope.VenCSItemGridDisplayCollection.forEach(function (item, index) {
                        // Add an index field to each object
                        item.index = index; // Adding 1 to start index from 1
                    });
                    $scope.loading = false;
                }).error(function () {
                    $scope.loading = false;
                });

            $http.post('/ClientRequisition/GetClientReqTermList', { ClientReqID: tableRow.ClientReqID })
                .success(function (response) {
                    $scope.ReqTermDataSetupGridData = response.ClientReqTermList;
                    $scope.ReqTermGridDisplayCollection = [].concat($scope.ReqTermDataSetupGridData);
                    $scope.loading = false;
                }).error(function () {
                    $scope.loading = false;
                });

            $('#ClientInfoModal').modal('hide');
        };

        $scope.clearVendorCSAprv = function () {
            $scope.VendorCSAprv = {
                VendorCSAprvID: "",
                VendorID: "",
                VendorCode: "",
                VendorName: "",
                ContactPerson: "",
                ContactNumber: "",
                VendorTINNo: "",
                VendorBINNo: "",
                VendorAddress: "",
                RequisitionNo: "",
                SubmissionDate: "",
                RequisitionDate: "",
                Remarks: ""
            }

            $scope.VendorCSAprvItem = {
                VendorCSAprvItemID: "",
                VendorCSAprvID: "",
                Description: "",
                DeliveryLocation: "",
                DeliveryDate: "",
                ServiceCategory: { ServiceCategoryID: "", ServiceCategoryName: "" },
                ServiceItem: { ServiceItemID: "", ServiceItemName: "" },
                DeliveryMode: "",
                ReqQnty: "",
                ReqUnit: ""
            }
            $scope.VendorCSAprvTerm = {
                VendorCSAprvTermsID: "",
                VendorCSAprvID: "",
                TermsID: "",
                TermsCode: "",
                TermsName: ""
            }
            $scope.VendorCSVendorsItemWise = {
                VendorCSAprvID: "",
                VendorID: "",
                VendorName: "",
                TransactionName: "",
                VendorCSAprvItemID: "",
                ContactPerson: "",
                ContactNumber: "",
                VendorCSRecmID: "",
                VendorQutnNo: "",
                QuotationDate: "",
                TolQnty: "",
                VenReqUnit: "",
                Status: ""
            }

            $("#DeliveryDate").val('');
            $scope.VenCSItemList = [];  // base collection
            $scope.VenCSItemGridDisplayCollection = [].concat($scope.VenCSItemList);

            $scope.ReqTermDataSetupGridData = [];  // base collection
            $scope.ReqTermGridDisplayCollection = [].concat($scope.ReqTermDataSetupGridData);

            $scope.ReqWiseVendorList = [];  // base collection
            $scope.VendorInfoDisplayedCollection = [].concat($scope.ReqWiseVendorList);
        }

        $scope.toggleReqItemEdit = function (tableRow, $i) {
            $('#RequisitionItemModal').modal('show');
            $scope.resetVendorCSAprvItem();

            $scope.VendorCSAprvItem.VendorCSAprvItemID = tableRow.VendorCSAprvItemID;

            $scope.VendorCSAprvItem.ServiceCategory.ServiceCategoryID = tableRow.ServiceCategoryID;
            $scope.VendorCSAprvItem.ServiceCategory.ServiceCategoryName = tableRow.ServiceCategoryName;
            $scope.VendorCSAprvItem.ServiceItem.ServiceItemID = tableRow.ServiceItemID;
            $scope.VendorCSAprvItem.ServiceItem.ServiceItemName = tableRow.ServiceItemName;

            $scope.VendorCSAprvItem.DeliveryMode = tableRow.DeliveryMode;
            $scope.VendorCSAprvItem.DeliveryLocation = tableRow.DeliveryLocation;
            $scope.VendorCSAprvItem.DeliveryDate = tableRow.DeliveryDate;
            $scope.VendorCSAprvItem.Description = tableRow.Description;

            $scope.VendorCSAprvItem.ReqQnty = tableRow.ReqQnty;
            $scope.VendorCSAprvItem.ReqUnit = tableRow.ReqUnit;

            $scope.VenCSItemGridDisplayCollection.splice($i, 1);
            $scope.vendorCSItemArray.splice($i, 1);

            $http.post("/ServiceItemInfo/GetServiceItemInfoSearchList?ServiceItemCategoryID=" + tableRow.ServiceCategoryID)
                .success(function (response) {
                    $scope.loading = false;
                    $scope.serviceItems = response.ServiceItemInfoSearchList;
                })
                .error(function () { });

            $("#btnAddReqItem").html('Update');
        };

        $scope.toggleReqItemDelete = function (tableRow, $i) {
            if (!tableRow.VendorCSAprvItemID) {
                $scope.resetVendorCSAprvItem();
                $scope.VenCSItemGridDisplayCollection.splice($i, 1);
                $scope.vendorCSItemArray.splice($i, 1);
                toastr.success('Data Deleted Successsfully');
            }
            else {
                $scope.resetVendorCSAprvItem();
                $scope.VendorCSAprvItem.VendorCSAprvItemID = tableRow.VendorCSAprvItemID;
                $('#deleteReqItemModal').modal('show');
            }
        };

        $scope.DeleteVendorCSAprvItem = function () {
            $http.post('/VendorCSAprv/DeleteVendorCSAprvItemAndTerm',
                { VendorCSAprvItemID: $scope.VendorCSAprvItem.VendorCSAprvItemID, VendorCSAprvTermID: $scope.VendorCSAprvTerm.VendorCSAprvTermID })
                .success(function (response) {
                    if (response.status == "S203") {
                        $scope.resetVendorCSAprvItem();
                        $scope.VenCSItemGridDisplayCollection.splice($i, 1);
                        $scope.vendorCSItemArray.splice($i, 1);
                        toastr.success('Data Deleted Successsfully');
                        return;
                    }
                });
        }

        ////////////////////////Select for Update from Search grid ///////////////////////
        $scope.toggleVendorWiseItemReqDelete = function (tableRow, $i) {
            if (!tableRow.VendorCSAprvItemWiseID) {
                $scope.resetVendorWiseItemReq();
                $scope.VendorInfoDisplayedCollection.splice($i, 1);
                //$scope.vendorCSItemArray.splice($i, 1);
                toastr.success('Data Deleted Successsfully');
            }
            else {
                $scope.resetVendorWiseItemReq();
                $scope.VendorCSVendorsItemWise.VendorCSAprvItemWiseID = tableRow.VendorCSAprvItemWiseID;
                $('#deleteReqItemModal').modal('show');
            }
        };

        $scope.toggleVendorSelect = function (row) {

            $scope.VendorCSAprv.VendorID = row.VendorID;
            $scope.VendorCSAprv.VendorCode = row.VendorCode;
            $scope.VendorCSAprv.VendorName = row.VendorName;

            $scope.VendorCSVendorsItemWise.VendorID = row.VendorID;
            $scope.VendorCSVendorsItemWise.VendorName = row.VendorName;
            $scope.VendorCSVendorsItemWise.TransactionName = row.TransactionName;
            $scope.VendorCSVendorsItemWise.ContactPerson = row.ContactPerson;
            $scope.VendorCSVendorsItemWise.ContactNumber = row.ContactNumber;
            $scope.VendorCSVendorsItemWise.Email = row.Email;
            $scope.VendorCSVendorsItemWise.Address = row.Address;

            $scope.VendorInfoDisplayedCollection = $scope.VendorInfoDisplayedCollection.concat($scope.VendorCSVendorsItemWise);

            $scope.resetVendorWiseItemReq();

            $('#VendorInfoModal').modal('hide');
        };

        ////////////////////////////////////

        $scope.selectedRowsForVendor = [];
        $scope.SelectedVendorForBiddingDisplayedCollection = [];
        $scope.showVendorforBiddingArea = false;

        $scope.selectEntity = function (row) {
            var selecteditems = {
                VendorCSRecmID: row.VendorCSRecmID,
                VendorID: row.VendorID,
                VendorName: row.VendorName,
                ContactPerson: row.ContactPerson,
                ContactNumber: row.ContactNumber,
                VendorQutnNo: row.VendorQutnNo,
                QuotationDate: row.QuotationDate,
                TolQnty: row.TolQnty,
                index: row.index
            };
            var indexToRemove = -1;
            $scope.selectedRowsForVendor.forEach(function (item, index) {
                if (item.index === selecteditems.index) {
                    indexToRemove = index;
                }
            });
            if (indexToRemove !== -1) {
                $scope.selectedRowsForVendor.splice(indexToRemove, 1);
                $scope.SelectedVendorForBiddingDisplayedCollection.splice(indexToRemove, 1);
                row.selected = false;
            }

            else {
                $scope.selectedRowsForVendor.push(selecteditems);
                $scope.SelectedVendorForBiddingDisplayedCollection = [].concat($scope.selectedRowsForVendor);
                row.selected = true;
                $scope.showVendorforBiddingArea = true;
            }
            row.buttonCheckedforVendor = row.selected;

            if ($scope.selectedRowsForVendor.length <= 0) {
                $scope.showVendorforBiddingArea = false;
            }
        };

        $scope.resetVendorWiseItemReq = function () {
            $scope.VendorCSVendorsItemWise = {
                VendorCSAprvID: "",
                VendorID: "",
                VendorName: "",
                TransactionName: "",
                VendorCSAprvItemID: "",
                ContactPerson: "",
                ContactNumber: "",
                VendorTINNo: "",
                VendorBINNo: "",
                VendorEmail: "",
                VendorAddress: "",
                VenReqQnty: "",
                VenReqUnit: "",
                Status: ""
            }
        }

        ///////////////////////Save/Update Master///////////////////////

        //////////////////Search Grid List///////////////////////////////

        $scope.SearchVendorCSAprvModal = function () {
            $scope.GetVendorCSAprvSearchList();
            $('#SearchVendorCSAprvModal').modal('show');
        };

        $scope.GetVendorCSAprvSearchList = function () {
            $http.post("/VendorCSAprv/GetVendorCSAprvSearchList")
                .success(function (response) {
                    $scope.vendorCSSearchList = response.vendorCSSearchList;
                    $scope.vendorCSDisplayedCollection = [].concat($scope.vendorCSSearchList);
                })
                .error(function () { });
        }

        ////////////////////////Select for Update from Search grid ///////////////////////

        $scope.toggleVendorCSAprvSelect = function (tableRow) {
            $scope.VendorCSAprv.VendorCSAprvID = tableRow.VendorCSAprvID;
            $scope.VendorCSAprv.ClientID = tableRow.ClientID;
            $scope.VendorCSAprv.ClientName = tableRow.ClientName;
            $scope.VendorCSAprv.VendorID = tableRow.VendorID;
            $scope.VendorCSAprv.VendorName = tableRow.VendorName;
            $scope.VendorCSAprv.RequisitionNo = tableRow.RequisitionNo;
            $scope.VendorCSAprv.RequisitionDate = tableRow.RequisitionDate;
            $scope.VendorCSAprv.SubmissionDate = tableRow.SubmissionDate;
            $scope.VendorCSAprv.LastDateofQuotation = tableRow.LastDateofQuotation;
            $scope.VendorCSAprv.Remarks = tableRow.Remarks;
            $scope.VendorCSAprv.Status = tableRow.Status;

            $http.post('/VendorCSAprv/GetVendorCSAprvItemList', { VendorCSAprvID: tableRow.VendorCSAprvID })
                .success(function (response) {
                    $scope.VenCSItemList = response.VendorCSAprvItemList;
                    $scope.VenCSItemGridDisplayCollection = [].concat($scope.VenCSItemList);
                    $scope.loading = false;
                }).error(function () {
                    $scope.loading = false;
                });

            $http.post('/VendorCSAprv/GetVendorCSAprvTermList', { VendorCSAprvID: tableRow.VendorCSAprvID })
                .success(function (response) {
                    $scope.ReqTermDataSetupGridData = response.VendorCSAprvTermList;
                    $scope.ReqTermGridDisplayCollection = [].concat($scope.ReqTermDataSetupGridData);
                    $scope.loading = false;
                }).error(function () {
                    $scope.loading = false;
                });

            $http.post('/VendorCSAprv/GetReqWiseVendorList', { VendorCSAprvID: tableRow.VendorCSAprvID })
                .success(function (response) {
                    $scope.ReqWiseVendorList = response.ReqWiseVendorList;
                    $scope.VendorInfoDisplayedCollection = [].concat($scope.ReqWiseVendorList);//VendorInfoDisplayedCollection
                    $scope.loading = false;
                })
                .error(function () { });


            $('#SearchVendorCSAprvModal').modal('hide');
        };

        ///////////////////////////////////////////////

        ////////////////////////Requsition Terms & Conditions ///////////////////////

        $scope.ShowTermsConditionsList = function () {
            $http.get("/VendorCSAprv/GetTermsConditionsList")
                .success(function (response) {
                    $scope.TermsConditionsList = response.termsConditionsList;
                    $scope.TermsConditionsDisplayedCollection = [].concat($scope.TermsConditionsList);
                    $scope.loading = false;
                })
                .error(function () { });

            $('#VendorCSAprvTermsConditionsModal').modal('show');
        };

        $scope.toggleTermsConditionsSelect = function (row) {
            $scope.VendorCSAprv.TermsID = row.TermsID;
            $scope.VendorCSAprv.FormName = row.FormName;

            $http.post('/VendorCSAprv/GetVendorCSAprvTermAgainstFormList', { TermsID: row.TermsID })
                .success(function (response) {
                    $scope.ReqTermDataSetupGridData = response.VendorCSAprvTermList;
                    $scope.ReqTermGridDisplayCollection = [].concat($scope.ReqTermDataSetupGridData);
                    $scope.loading = false;
                }).error(function () {
                    $scope.loading = false;
                });

            $('#VendorCSAprvTermsConditionsModal').modal('hide');
        };

        $scope.VendorCSAprvTerm = {
            VendorCSAprvTermsID: "",
            VendorCSAprvID: "",
            TermsID: "",
            TermsCode: "",
            TermsName: ""
        }

        $scope.AddReqTermModal = function () {

            if ($('#RequisitionNo').val() == "") {
                toastr.error("Vendor ReqNo.  Required");
                return;
            }

            if ($('#SubmissionDate').val() == "") {
                toastr.error("Submission Date Required.");
                return;
            }

            if ($('#RequisitionDate').val() == "") {
                toastr.error("Requisition Date Date Required");
                return;
            }
            $('#RequisitionTermModal').modal('show');
        };

        $scope.ReqTermDataSetupGridData = [];  // base collection
        $scope.ReqTermGridDisplayCollection = [].concat($scope.ReqTermDataSetupGridData);

        $scope.AddReqTerm = function () {

            if ($('#TermsCode').val() == "") {
                toastr.error("Terms Code Required");
                return;
            }

            if ($('#TermsName').val() == "") {
                toastr.error("Terms Name Required.");
                return;
            }

            $scope.VendorCSAprvTerm.TermsCode = $('#TermsCode').val();
            $scope.VendorCSAprvTerm.TermsName = $('#TermsName').val();

            $scope.vendorCSTermArray.push($scope.VendorCSAprvTerm);

            $scope.ReqTermGridDisplayCollection = $scope.ReqTermGridDisplayCollection.concat($scope.VendorCSAprvTerm);

            $scope.resetVendorCSAprvTerm();
            $("#btnAddReqTerm").html('Add');
            $('#RequisitionTermModal').modal('hide');
        }

        $scope.resetVendorCSAprvTerm = function () {
            $scope.VendorCSAprvTerm = {
                VendorCSAprvTermsID: "",
                VendorCSAprvID: "",
                TermsID: "",
                TermsCode: "",
                TermsName: ""
            }
        }

        $scope.toggleReqTermEdit = function (tableRow, $i) {
            $('#RequisitionTermModal').modal('show');
            $scope.resetVendorCSAprvTerm();
            $scope.VendorCSAprvTerm.VendorCSAprvTermID = tableRow.VendorCSAprvTermD;
            $scope.VendorCSAprvTerm.VendorCSAprvID = tableRow.VendorCSAprvID;
            $scope.VendorCSAprvTerm.TermsID = tableRow.TermsID;
            $scope.VendorCSAprvTerm.TermsCode = tableRow.TermsCode;
            $scope.VendorCSAprvTerm.TermsName = tableRow.TermsName;
            $scope.ReqTermGridDisplayCollection.splice($i, 1);
            $scope.vendorCSTermArray.splice($i, 1);
            $("#btnAddReqTerm").html('Update');
        };

        $scope.toggleReqTermDelete = function (tableRow, $i) {
            if (!tableRow.VendorCSAprvTermID) {
                $scope.resetVendorCSAprvTerm();
                $scope.ReqTermGridDisplayCollection.splice($i, 1);
                $scope.vendorCSTermArray.splice($i, 1);
                toastr.success('Data Deleted Successsfully');
            }
            else {
                $scope.resetVendorCSAprvTerm();
                $scope.VendorCSAprvTerm.VendorCSAprvTermID = tableRow.VendorCSAprvTermID;
                $('#deleteReqTermModal').modal('show');
            }
        };

        $scope.DeleteVendorCSAprvTerm = function () {
            $http.post('/VendorCSAprv/DeleteVendorCSAprvItemAndTerm',
                { VendorCSAprvItemID: $scope.VendorCSAprvItem.VendorCSAprvItemID, VendorCSAprvTermID: $scope.VendorCSAprvTerm.VendorCSAprvTermID })
                .success(function (response) {
                    if (response.status == "S203") {
                        $scope.resetVendorCSAprvTerm();
                        $scope.ReqTermGridDisplayCollection.splice($i, 1);
                        $scope.vendorCSTermArray.splice($i, 1);
                        toastr.success('Data Deleted Successsfully');
                        return;
                    }
                });
        }

        ///////////////////////////////////////////////

        $scope.Post = function () {

            //if ($('#RequisitionNo').val() == "") {
            //    toastr.error("Vendor ReqNo.  Required");
            //    return;
            //}

            //if ($('#SubmissionDate').val() == "") {
            //    toastr.error("Submission Date Required.");
            //    return;
            //}

            if ($('#CSRecDate').val() == "") {
                toastr.error("CSRecDate Date Required");
                return;
            }

            $scope.VendorCSAprv.CSRecDate = $('#CSRecDate').val();
            $http.post('/VendorCSAprv/SaveVendorCSAprv',
                {
                    vendorCS: $scope.VendorCSAprv,
                    vendorCSItem: $scope.VenCSItemGridDisplayCollection,
                    vendorCSTerm: $scope.ReqTermGridDisplayCollection,
                    vendorCSItemWise: $scope.SelectedVendorForBiddingDisplayedCollection
                })
                .success(function (response) {
                    if (response.status == "S201") {
                        toastr.success("Data Saved Successfully.");
                        $scope.clearVendorCSAprv();
                        $scope.loading = false;
                        return;
                    }
                    else if (response.status == "S202") {
                        toastr.success("Data Updated Successfully.");
                        $scope.clearVendorCSAprv();
                        $scope.loading = false;
                        return;
                    }
                    else if (response.status == "S203") {
                        toastr.success("Data Deleted Successfully.");
                        $scope.clearVendorCSAprv();
                        $scope.loading = false;
                        return;
                    }
                    else {
                        toastr.error("Data Save Failed.");
                        $scope.loading = false;
                        return;
                    }
                })
                .error(function () {
                    toastr.error("Data Save Failed.");
                    $scope.loading = false;
                    return;
                });
        }

        $scope.toggleRefreshTable = function () {
            window.location.reload();
        };
    }])
</script>

