@{
    Layout = "~/Views/Shared/_AdminLteLayout.cshtml";
}

<div class="box box-primary box-body" ng-controller="TermsCtrl">
    <form name="Terms" novalidate ng-submit="submitform(Terms.$valid)" autocomplete="off">
        <!-- box-header  box header-->
        <div class="box-header with-border bg-light-blue-gradient" style="height:38px;">
            @*<i class="fa fa-list-alt"></i>*@
            <h2 class="box-title" style="font-family: 'MV Boli';font-weight:500; ">Terms Information</h2>
            <div class="box-tools pull-right">
                <div class="col-lg-12 pull-right">
                    <div class="btn-group pull-right" style="margin-left: 4px; margin-right: 4px;">
                        <button type="button" data-ng-click="toggleRefreshTable()" class="button-custom" ng-disabled="btnRefresh"><i class="fa fa-refresh" style="padding-right: 5px"></i>Refresh</button>
                    </div>
                    <div class="btn-group pull-right" style="margin-left: 4px; margin-right: 4px;">
                        <button type="button" data-ng-click="SearchTermsModal()" class="button-custom" ng-disabled="btnSearch"><i class="fa fa-search" style="padding-right: 5px"></i>Search</button>
                    </div>
                    <div class="btn-group pull-right" style="margin-left: 4px; margin-right: 4px;">
                        <button type="button" data-ng-click="Post()" class="button-custom" ng-disabled="btnSave"><i class="fa fa-save" style="padding-right: 5px"></i>Save</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="box-body">
            <div class="row">
                <div class="col-sm-2 col-md-2 col-lg-2">
                    <div class="form-group">
                        <label>Form Code</label>
                        <label style="font-size: larger;color:red;">*</label>
                    </div>
                </div>
                <div class="col-sm-2 col-md-2 col-lg-2">
                    <input id="FormCode" name="FormCode" type="text" autocomplete="off" class="form-control" placeholder="Form Code" required data-ng-model="vmTermsMst.FormCode" style="height: 25px; background-color:#ffffff; font-size: smaller" />
                </div>
                <div class="col-sm-2 col-md-2 col-lg-2">
                    <div class="form-group">
                        <label for="FormName">Form Name</label>
                        <label style="font-size: larger;color:red;">*</label>
                    </div>
                </div>
                <div class="col-sm-5 col-md-5 col-lg-5">
                    <div class="form-group">
                        <input id="FormName" type="text" name="FormName" required class="form-control" autofocus ng-model="vmTermsMst.FormName" placeholder="Form Name" style="height: 25px; font-size: smaller" />
                        <p ng-show="Terms.FormName.$error.required && !Terms.FormName.$pristine" class="help-block" style="height:10px;">Terms Name is required.</p>
                    </div>
                </div>
            </div>

            <div class="row" style="position:relative;top:2px;">
                <div class="col-md-12">
                    <div class="box box-info" style="border-bottom: 1px solid #d3e3e3; ">
                        <div class="box-header with-border" style="height: 40px; border-bottom: 1px solid #d3e3e3;">
                            <h2 class="box-title" style="font-family: Verdana; font-size: 16px; font-weight: bold; color: #166e19;">Terms List</h2>
                            <div class="box-tools pull-right">
                                <div class="col-lg-12 pull-right">
                                    <div class="btn-group pull-right" style="margin:2px;">
                                        <button type="button" id="btnAdd" ng-disabled="btnAdd" data-ng-click="AddDtlModal()" class="button-detail btn"><i class="fa fa-plus" style="padding-right: 3px"></i>Add</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="TermsDtlModal" class="modal fade">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="row">
                            <div class="col-sm-5 col-md-5 col-lg-5">
                                <h3 class="modal-title">Terms Information</h3>
                            </div>
                            <div class="col-sm-6 col-md-6 col-lg-6">
                            </div>
                            <div class="col-sm-1 col-md-1 col-lg-1">
                                <button type="button" class="close" data-dismiss="modal" ng-click="ResetDtlModel()" aria-hidden="true" style="color:red;">x</button>
                            </div>
                        </div>
                    </div>
                    <div ng-cloak>
                        <div class="row" style="position:relative;top:5px;">
                            <div class="col-sm-1 col-md-1 col-lg-1">
                            </div>
                            <div class="col-sm-2 col-md-2 col-lg-2">
                                <div class="form-group">
                                    <label for="TermsCode">Terms Code</label>
                                    <label style="font-size: larger;color:red;">*</label>
                                </div>
                            </div>
                            <div class="col-sm-2 col-md-2 col-lg-2">
                                <input id="TermsCode" type="text" name="TermsCode" required class="form-control" autofocus ng-model="vmTermsItem.TermsCode" placeholder="TermsCode" style="height: 25px; font-size: smaller" />
                            </div>

                            <div class="col-sm-1 col-md-1 col-lg-1">
                            </div>

                            <div class="col-sm-2 col-md-2 col-lg-2">
                                <div class="form-group">
                                    <label for="TermsName">Terms Name</label>
                                    <label style="font-size:larger;color:red;">*</label>
                                </div>
                            </div>
                            <div class="col-sm-2 col-md-2 col-lg-2">
                                <input id="TermsName" name="TermsName" type="text" class="form-control" placeholder="Contact Number"
                                       ng-model="vmTermsItem.TermsName" style="height: 25px; background-color:#ffffff; font-size: smaller" />
                            </div>
                        </div>

                        <div class="row" style="position: relative; top: -3px; margin-bottom: 5px;">
                            <div class="col-sm-1 col-md-1 col-lg-1">
                            </div>
                            <div class="col-sm-2 col-md-2 col-lg-2">
                                <div class="form-group">
                                    <label for="ItemStatus">Status</label>
                                </div>
                            </div>
                            <div class="col-sm-2 col-md-2 col-lg-2">
                                <select data-ng-model="vmTermsItem.ItemStatus" class="form-control">
                                    <option value="">-- None --</option>
                                    <option value="1">Active</option>
                                    <option value="0">Inactive</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div class="col-sm-12 col-md-12 col-lg-12">
                            <div class="form-group">
                                <div class="btn-group pull-right" style="margin:2px;">
                                    <button type="button" id="btnDtlSaveUpdate" data-ng-click="AddUpdateDtl()" class="button-detail btn"><i class="fa fa-save" style="padding-right: 3px"></i>Save</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <div class="table-responsive">
        <table st-table="displayedCollection" @*st-safe-src="getAllTermsDtl"*@ class="table table-condensed table-bordered table-striped table-hover pnlView">
            <thead>
                <tr style="color: darkblue;">
                    <th class="col-lg-1 col-md-1 col-sm-1" st-sort="TermsItemID">SL.</th>
                    <th class="col-lg-2 col-md-2 col-sm-2" st-sort="TermCode">Terms Code</th>
                    <th class="col-lg-1 col-md-1 col-sm-1" st-sort="TermName">Terms Name</th>
                    <th class="col-lg-1 col-md-1 col-sm-1" st-sort="ItemStatus">Status</th>
                    <th class="col-lg-2 col-md-2 col-sm-2">Action</th>
                </tr>
                @*<tr>
                        <th><input st-search="TermsCode" placeholder="Sl No" class="input-sm form-control" type="search" /></th>
                        <th></th>
                        <th><input st-search="TermsName" placeholder="Introduce Date" class="input-sm form-control" type="search" /></th>
                    </tr>*@
            </thead>
            <tbody>
                <tr ng-repeat="row in displayedCollection" style="height:20px;">
                    @*<td class="hidden">{{row.TermsItemID}}</td>*@
                    <td class="col-lg-1 col-md-1 col-sm-1">{{row.TermsItemID}}</td>
                    <td class="col-lg-2 col-md-2 col-sm-2">{{row.TermsCode}}</td>
                    <td class="col-lg-1 col-md-1 col-sm-1">{{row.TermsName}}</td>
                    <td class="col-lg-1 col-md-1 col-sm-1 text-center">
                        <span ng-attr-class="{{row.ItemStatus =='1'? 'label label-success' : 'label label-danger' }}">
                            {{row.ItemStatus == '1'? 'Active':'InActive'}}
                        </span>
                    </td>
                    <td class="col-lg-2 col-md-2 col-sm-2 text-center">
                        <button type="button" class="button-detail" style="height:28px;" data-ng-click="toggleEdit(row)"><i class="fa fa-edit"></i> Edit</button>
                        <button type="button" class="btn-danger" data-toggle="tooltip" data-placement="top" title="Delete" data-ng-click="toggleDelete(row)">Delete<i class="fa fa-remove"></i></button>
                    </td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="7" class="text-center">
                        <div st-pagination="" st-items-by-page="itemsByPage" st-displayed-pages="100"></div>
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>

  

    <div id="SearchTermsModal" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" ng-click="ResetSearchModel()" aria-hidden="true">x</button>
                    <h3 class="modal-title">Terms Information</h3>
                </div>
                <div class="table-responsive" data-ng-disabled="" ng-cloak>
                    <table st-table="TermsDisplayedCollection" st-safe-src="TermsSearchList" class="table table-condensed table-bordered table-striped table-hover pnlView">
                        <thead>
                            <tr>
                                <th class="col-lg-1 col-md-1 col-sm-1" data-ng-click="sort('FormCode')">Form Code</th>
                                <th class="col-lg-1 col-md-1 col-sm-1" data-ng-click="sort('FormName')">Form Name</th>
                                <th class="col-lg-2 col-md-2 col-sm-2" data-ng-click="sort('Status')">Status</th>
                                <th class="col-lg-1 col-md-1 col-sm-1">Action</th>
                            </tr>
                            <tr>
                                <th><input st-search="TermsCode" placeholder="Terms Code" class="input-sm form-control" type="search" /></th>
                                <th><input st-search="TermsName" placeholder="TermsName" class="input-sm form-control" type="search" /></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="row in TermsDisplayedCollection">
                                <td class="hidden">{{row.TermsID}}</td>
                                <td class="col-lg-1 col-md-1 col-sm-1 text-center">{{row.FormCode}}</td>
                                <td class="col-lg-3 col-md-3 col-sm-3 text-center">{{row.FormCode}}</td>
                                <td class="col-lg-1 col-md-1 col-sm-1 text-center">
                                    <span ng-attr-class="{{row.Status =='1'? 'label label-success' : 'label label-danger' }}">
                                        {{row.Status == '1'? 'Active':'InActive'}}
                                    </span>
                                </td>

                                <td>
                                    <a class="btn col-center btn-sm btn-flat btn-success" ng-href="#" ng-rel="" data-ng-click="toggleTermsSelect(row)">Select</a>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="9" class="text-center"><div st-pagination="" st-items-by-page="itemsByPage" st-displayed-pages="100"></div></td>
                            </tr>
                        </tfoot>

                    </table>
                </div>
                <div class="modal-footer">
                    <div class="col-sm-12 col-md-12 col-lg-12">
                        <div class="form-group">
                            <button type="button" class="btn btn-default" data-dismiss="modal" ng-click="ResetSearchModel()">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Delete ServiceCategory Modal -->
    <div id="deleteModal" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h3 class="modal-title">Delete Confirmation</h3>
                </div>
                <div class="modal-body">
                    <div class="box-body">
                        <div class="form-group">
                            <label>Are you sure? </label>
                            <p> You want to delete this record.</p>
                        </div>
                    </div><!-- /.box-body -->
                </div>
                <div class="modal-footer">
                    <button type="button" id="yes" class="btn btn-danger" ng-disabled="loading" data-ng-click="deleteConfirm()">Yes</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">No</button>

                </div>
            </div>
        </div>
    </div>
    <!-- /Delete ServiceCategory Modal -->
    <div id="mydiv" data-ng-show="loading">
        <div class="overlay">
            <div class="loder">
                <img src="~/Content/AdminLTE/img/cube.gif" /> <span class="text-bold">Loading...</span>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">

    app.controller('TermsCtrl', function ($scope, $http) {
        //applySecurity();

        ///////////////Variable Declaration////////////////////////
        $scope.itemsByPage = 20;
        $scope.getAllTermsDtl = [];  // base collection
        $scope.displayedCollection = [].concat($scope.getAllTermsDtl);  // displayed collection
        $scope.disableKey = true;

        ///////////////Master Model////////////////

        $scope.vmTermsMst =
        {
            TermsID: "",
            TermsCode: "",
            TermsName: "",
            TermsCategory: { TermsCategoryID: "", TermsCategoryName: "" },
            TermsTinNo: "",
            TermsBinNo: "",
            Status: ""
        };

        $scope.ClearTerms = function () {
            $scope.vmTermsMst =
            {
                TermsID: "",
                FormCode: "",
                FormName: "",
                Status: ""
            };
        }
        $scope.ClearTerms();
        ///////////////Detail Add Model////////////////
        $scope.vmTermsItem =
        {
            TermsItemID: "",
            TermsCode: "",
            TermsName: "",
            ItemStatus: ""
        };

        ///////////////Reset Detail Model////////////////
        $scope.ClearTermsItem = function () {
            $scope.vmTermsItem.TermsItemID = "";
            $scope.vmTermsItem.TermsCode = "";
            $scope.vmTermsItem.TermsName = "";
            $scope.vmTermsItem.ItemStatus = "";
        }

        ///////////////////////Default Value////////////////////////

        $scope.vmTermsMst.Status = "1";
        $scope.vmTermsItem.ItemStatus = "1";

        //////////////////Search Grid List///////////////////////////////

        $scope.SearchTermsModal = function () {
            $scope.GetTermsSearchList();
            $('#SearchTermsModal').modal('show');
        };

        $scope.GetTermsSearchList = function () {
            $http.post("/Terms/GetTermsSearchList")
                .success(function (response) {
                    $scope.TermsSearchList = response.TermsSearchList;
                    $scope.TermsDisplayedCollection = [].concat($scope.TermsSearchList);
                })
                .error(function () { });
        }

        ///////////////////////////////////////////////

        ////////////////////////Select for Update from Search grid ///////////////////////

        $scope.toggleTermsSelect = function (tableRow) {

            $scope.vmTermsMst.TermsID = tableRow.TermsID;
            $scope.vmTermsMst.FormCode = tableRow.FormCode;
            $scope.vmTermsMst.FormName = tableRow.FormName;
            $scope.vmTermsMst.Status = tableRow.Status;

            $http.post('/Terms/GetTermsItemList', { TermsID: tableRow.TermsID })
                .success(function (response) {
                    $scope.ClearTermsItem();
                    $scope.getAllTermsDtl = response.TermsItemList;
                    $scope.displayedCollection = [].concat($scope.getAllTermsDtl);  // displayed collection
                    $scope.loading = false;
                }).error(function () {
                    $scope.loading = false;
                });

            $('#SearchTermsModal').modal('hide');
        };

        ///////////////////////Save/Update Master///////////////////////

        $scope.Post = function () {

            if ($("#FormCode").val() == "") {
                toastr.error("Terms Code is required");
                return;
            }

            if ($("#FormName").val() == "") {
                toastr.error("Terms Name is required");
                return;
            }
            
            $scope.loading = true;
            $scope.vmTermsMst.TermsCode = $('#FormCode').val();
            $scope.vmTermsMst.TermsName = $('#FormName').val();
            $scope.vmTermsMst.Status = $scope.vmTermsMst.Status;

            $http.post('/Terms/SaveTermsMst', { _modelTermsMst: $scope.vmTermsMst, itemList: $scope.getAllTermsDtl })
                .success(function (response) {
                    if (response.status == "S201") {
                        toastr.success("Data Saved Successfully.");
                        $scope.ClearTerms();
                        $scope.loading = false;
                        return;
                    }
                    else if (response.status == "S202") {
                        toastr.success("Data Updated Successfully.");
                        $scope.ClearTerms();
                        $scope.loading = false;
                        return;
                    }
                    else if (response.status == "S203") {
                        toastr.success("Data Deleted Successfully.");
                        $scope.ClearTerms();
                        $scope.loading = false;
                        return;
                    }
                    else {
                        toastr.error("Data Save Failed.");
                        $scope.loading = false;
                        return;
                    }
                })
                .error(function () {
                    toastr.error("Data Save Failed.");
                    $scope.loading = false;
                    return;
                });
        };

        ////////////////////////////////////////////////////////////////////////////////

        //################ Save/Update Detail ###################
        $scope.displayedCollection = [];
        $scope.AddUpdateDtl = function () {

            if ($("#TermsCode").val() == "") {
                toastr.error("Contact Person required");
                return;
            }

            if ($("#TermsName").val() == "") {
                toastr.error("Contact Number Date required");
                return;
            }

            if ($("#Address").val() == "") {
                toastr.error("Address required");
                return;
            }

            $scope.loading = true;
            //$scope.vmTermsItem.TermsItemID = $scope.vmTermsItem.TermsItemID;// $('#TermsItemID').val();
            //$scope.vmTermsItem.TermsID = $scope.vmTermsMst.TermsID;// $('#TermsID').val();
            //$scope.vmTermsItem.TermsCode = $('#TermsCode').val();
            //$scope.vmTermsItem.TermsName = $('#TermsName').val();
            //$scope.vmTermsItem.ItemStatus = $scope.vmTermsItem.ItemStatus;
            ////////////////////////////////
            $scope.getAllTermsDtl.push($scope.vmTermsItem);
            $scope.loading = false;
            $('#TermsDtlModal').modal('hide');
            //$scope.displayedCollection = $scope.displayedCollection.concat($scope.vmTermsItem);
            $scope.displayedCollection = $scope.displayedCollection.concat($scope.vmTermsItem);
            
            /*$scope.ClearTermsItem();*/
            ////////////////////////////////////////////////


            //$http.post('/Terms/SaveTermsItem', { _modelTermsItem: $scope.vmTermsItem })
            //    .success(function (response) {
            //        if (response.status == "S201") {
            //            toastr.success("Data Saved Successfully.");
            //            $scope.ClearTermsItem();
            //            $scope.loading = false;

            //            $('#TermsDtlModal').modal('hide');
            //            $scope.GetTermsItemList();
            //            return;
            //        }
            //        else if (response.status == "S202") {
            //            toastr.success("Data Updated Successfully.");
            //            $scope.ClearTermsItem();
            //            $scope.loading = false;

            //            $('#TermsDtlModal').modal('hide');

            //            $scope.GetTermsItemList();
            //            return;
            //        }
            //        else if (response.status == "S203") {
            //            toastr.success("Data Deleted Successfully.");
            //            $scope.ClearTermsItem();
            //            $scope.loading = false;
            //            $('#TermsDtlModal').modal('hide');
            //            $scope.GetTermsItemList();
            //            return;
            //        }
            //        else {
            //            toastr.error("Data Save Failed.");
            //            $scope.loading = false;
            //            return;
            //        }
            //        $scope.loading = false;
            //        return;
            //    })
            //    .error(function () {
            //        toastr.error("Data Save Failed");
            //        $scope.loading = false;
            //        return;
            //    });
        };

        $scope.GetTermsItemList = function () {
            $http.post('/Terms/GetTermsItemList', { TermsID: $scope.vmTermsMst.TermsID })
                .success(function (response) {
                    $scope.ClearTermsItem();
                    $scope.getAllTermsDtl = response.TermsItemList;
                    $scope.displayedCollection = [].concat($scope.getAllTermsDtl);  // displayed collection
                    $scope.loading = false;
                }).error(function () {
                    $scope.loading = false;
                });
        }

        // ################# Detail Add Modal ####################
        $scope.AddDtlModal = function () {

            $scope.ClearTermsItem();
            
            $('#TermsDtlModal').modal('show');
            $scope.vmTermsItem.ItemStatus = "1";
            $("#btnDtlSaveUpdate").html('Add');
        };

        // ################# Detail Edit Modal ####################
        $scope.toggleEdit = function (row) {
            $('#TermsDtlModal').modal('show');
            $scope.loading = true;
            //console.log(row);
            $scope.vmTermsItem.TermsItemID = row.TermsItemID;
            $scope.vmTermsMst.TermsID = row.TermsID;
            $scope.vmTermsItem.TermsCode = row.TermsCode;
            $scope.vmTermsItem.TermsName = row.TermsName;
            $scope.vmTermsItem.ItemStatus = row.ItemStatus;

            $scope.loading = false;
            $("#btnDtlSaveUpdate").html('Update');
        };

        //#################### Delete Action ###############
        $scope.deleteConfirm = function () {
            var postData = JSON.stringify(convArrToObj($scope.vmTermsItem));
            $scope.loading = true;
            $http.post('/Terms/DeleteTermsItem', postData).success(function (response) {
                $scope.loading = false;
                if (response.status == "S203") {
                    toastr.success("Data Deleted Successfully.");
                    $scope.ClearTermsItem();
                    $('#deleteModal').modal('hide');
                    $scope.loading = false;
                    $scope.GetTermsItemList();
                    return;
                }
            }).error(function (data) {
                $scope.loading = false;
                toastr.error(data);
            });
        };

        $scope.toggleDelete = function (row) {
            $scope.vmTermsItem = row;
            $('#deleteModal').modal('show');
        };


        $scope.ResetDtlModel = function () {
            $scope.ClearTermsItem();
        };

        $scope.toggleRefreshTable = function () {
            window.location.reload();
        };
        ////////////////////////////////////////////////////////////////////////////////
    });

</script>